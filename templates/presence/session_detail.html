{% extends "base.html" %}
{% load static %}

{% block title %}Session: {{ session.cours.nom }}{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-lg-7">
    <div class="card shadow-sm">
      <div class="card-header">
        <h2 class="h4 mb-0">Session : {{ session.cours.nom }}</h2>
        <p class="text-muted mb-0">Lancée le {{ session.date_debut }}</p>
      </div>
      <div class="card-body text-center p-4">
        <h3 class="h5">Projetez ce QR Code</h3>


              <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <span class="badge bg-success">En ligne</span>
            <small class="text-muted">Lancée à {{ session.date_debut|date:"H:i" }}</small>
        </div>

        {% if session.actif %}
        <form action="{% url 'arreter_session' session.id %}" method="post" onsubmit="return confirm('Voulez-vous vraiment terminer cette séance ? Le QR code ne fonctionnera plus.');">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">
                <i class="bi bi-stop-circle-fill"></i> Finir la séance
            </button>
        </form>
        {% else %}
            <div class="alert alert-secondary py-1 px-2 mb-0">Séance terminée</div>
        {% endif %}
    </div>


        <div id="qr-code-container"
             data-refresh-url="{% url 'rafraichir_qr' session.id %}"
             data-session-id="{{ session.id }}">

          <img id="qr-code-image"
               src="data:image/png;base64,{{ qr_image_base64 }}"
               alt="QR Code de présence"
               class="img-fluid"
               style="max-width: 450px; border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
        </div>

        <div class="mt-3">
          <div class="spinner-border spinner-border-sm text-primary" role="status" id="qr-spinner" style="display: none;"></div>
          <span class="text-muted" id="qr-timer">Prochain rafraîchissement dans 10:00</span>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-header">
        <h3 class="h5 mb-0">Présences en temps réel (<span id="presence-count">0</span>)</h3>
      </div>
      <div class="card-body" style="max-height: 500px; overflow-y: auto;"
           data-presences-url="{% url 'get_presences_api' session.id %}"> <ul class="list-group list-group-flush" id="liste-presences">
          <li class="list-group-item text-muted" id="aucune-presence">Aucun étudiant présent pour le moment.</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% if session.actif %}
    <div class="alert alert-info">
        Session en cours...
        <a href="{% url 'arreter_session' session.id %}" class="btn btn-danger float-end">
            <i class="bi bi-stop-circle"></i> Terminer la séance
        </a>
    </div>
{% else %}
    <div class="alert alert-secondary">
        Cette session est terminée depuis le {{ session.date_fin|date:"H:i" }}.
    </div>

{% endif %}

{% block scripts %}
  <script src="{% static 'js/session_refresh.js' %}"></script>

  <script src="{% static 'js/realtime_presence.js' %}"></script>
{% endblock %}